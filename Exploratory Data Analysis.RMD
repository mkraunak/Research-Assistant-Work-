---
title: "Exploratory Data Analysis Task 1"
author: "Mayank"
date: "September 25, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(MASS)
library(broom)
library(ggplot2)
cb_palette = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
# Load the data
barley = read.table("minnesota.barley.yield.txt",stringsAsFactors = FALSE
                    ,col.names = c("yield","gen","year","site"),header = TRUE)

# Encode the columns properly
barley$yield = as.double(barley$yield)
barley$gen = as.factor(barley$gen)
barley$year = as.integer(barley$year)
barley$site = as.factor(barley$site)

# View the data
View(barley)

# View the summary of the data
summary(barley)
```

```{r}
# Faceted graph showing how barley yield varied by year at each location
ggplot(barley,aes(x=year,y=yield,color=site,group=gen)) + geom_line() + facet_wrap(~ site) + scale_colour_manual(name="Sites",values = cb_palette) + xlab("Year") + ylab("Yield(barley crop yield in bushels per acre)") + ggtitle("Barley yield vs year faceted by location.")
```

When looking at succesive years it was more common for the yields to increase at some locations and decrease at other locations. For example, in 1934 we can see that a peak in the yields was observed at Crookston, Duluth and GrandRapids while a drop/valley in the yeilds is observed at StPaul and Waseca. Also this effect is not consistent i.e these groups do not exhibit the same pattern all the time, for example in 1929 StPaul saw a rise in the yields while Waseca saw a drop in the yields.     

Model the data using an RLM

```{r}
# First try a rlm model having no interactions
barley.rlm = rlm(yield ~ gen + year + site, data=barley, psi = psi.bisquare, maxit=50)
# Summarize the model
summary(barley.rlm)
```

```{r}
# Get the r squared metric for the model
barley.rlm.df = augment(barley.rlm)
# R squared
R_squared = var(barley.rlm.df$.fitted) / (var(barley.rlm.df$.fitted) + var(barley.rlm.df$.resid))
R_squared
```

The R squared value for the rlm is quite low indicating that it can only explain 27% of the variation in our data.    

We choose a RLM(Robust Linear Model) to model the data as an rlm is robust to outliers and this outlier resistance can be increased by setting psi = psi.bisquare. We use the formula $yield = gen + site + year$ for our RLM. We could also use an interaction in the RLM between site and year but this leads to having a different combination each time due to the year and the RLM would then try to memorize the values. Also an interaction between gen and site is not possible as singular fits are not allowed in RLMs.

For the time being lets use this model for our plots.

```{r}
# Let's check the residuals vs fitted plot
ggplot(barley.rlm.df,aes(x=.fitted,y=.resid)) + geom_point() + geom_smooth() + ggtitle("Check if there is any pattern in the residuals") + xlab("Fitted values") + ylab("Residuals")
```

The residual vs fitted plot can be described by an almost linear model at 0, also there is not any distinguishable pattern in the residuals.     

```{r}
# Let's check the homoskedasticity for our model
ggplot(barley.rlm.df,aes(x=.fitted,y=abs(.resid))) + geom_point() + geom_smooth() + xlab("Fitted values") + ylab("Absolute residuals") + ggtitle("Check homoskedasticity of the data")
```

```{r}
# Plot all the residuals excepts for morris
barley.rlm.not_morris.df = barley.rlm.df[barley.rlm.df$site!="Morris",]
ggplot(barley.rlm.df,aes(x=year,y=.resid,color=site)) + geom_jitter(alpha=0.2) + geom_smooth(se=F) + scale_color_manual(name="Sites",values=cb_palette) + ggtitle("Residual patterns for sites w.r.t year") + xlab("Year") + ylab("Residuals")
```

```{r}
# Plot all the residuals excepts for morris
ggplot(barley.rlm.df,aes(x=year,y=.fitted,color=site)) + geom_jitter(alpha=0.2) + geom_smooth(se=F) + scale_color_manual(name="Sites",values=cb_palette) + ggtitle("Fitted value patterens for the different sites vs the year") + ylab("Fitted values") + xlab("Year")
```

From the residual vs year and fitted vs year graphs above we can see that from 1931 to 1932 all the residuals have dropped except for Morris and Waseca. The increase in residual values for Waseca is quite less as compared to Morris. Also we can see that the rlm used almost linear negative sloped generators to fit the data, so with each increasing year the rlm outputs a lesser yield value. We can observe that from 1931 - 1932 ouputting low values resulted in smaller residuals indicating a potential dip across all sites but Morris and Waseca whose residuals increased in magnitude. Morris residuals increased the most.    

However I would classify Morris 1931-1932 as natural variation rather than a mistake because:         
1. Our RLM model is very naive and cannot explain most of the variation in our data.    
2. The increase/decrease of yields is not consistent for all the 6 sites for the same years. Therefore, a drop in yields for all sites except Morris is not conclusive that Morris 1931-1932 was a mistake.     
