---
title: "Problem set 5"
author: "Mayank Raunak"
date: "February 25, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r,results='hide',warning=FALSE,message=FALSE,echo=F}
library(tidyverse)
library(NHANES)
library(dplyr)
library(mgcv)
library(cowplot)
library(broom)
library(arm)
cb_palette = c("#999999", "magenta", "#56B4E9", "plum", "maroon", "#0072B2", "sienna", "#CC79A7", 'lightsalmon', "orchid", "sky blue","black","cyan","coral4","navy","purple")
```
```{r,echo=F,warning=F,message=F}
# Select columns from the data
columns = c('BMI','Age','Height')
BMI.data = NHANES[columns]

# Remove the NA values from data
BMI.data = na.omit(BMI.data)
# New summary
#summary(BMI.data)

```




##### Model Selection

```{r,warning=F,message=F}
# Try a loess model of degree 1

BMI.lo = loess((BMI) ~ (Height) * (Age),degree = 1, span=0.55,data =BMI.data,family = "symmetric", normalize = FALSE)
```


```{r,echo=F,warning=F,message=F,results='hide'}
BMI1.ls.model.df = augment(BMI.lo)
ls1.r2 = var(BMI1.ls.model.df$.fitted) / (var(BMI1.ls.model.df$.fitted) + var(BMI1.ls.model.df$.resid))
print(BMI.lo)
cat("R squared = ",ls1.r2)
```
```{r,echo=F,warning=F,message=F,results='hide'}
# Try a loess model of degree 2
BMI.ls.model = loess((BMI) ~ (Height) * (Age),data = BMI.data,span=0.8)
BMI.ls.model.df = augment(BMI.ls.model)
ls.r2 = var(BMI.ls.model.df$.fitted) / (var(BMI.ls.model.df$.fitted) + var(BMI.ls.model.df$.resid))
print(BMI.ls.model)
cat("R squared = ",ls.r2)
```

```{r,echo=F,warning=F,message=F,results='hide'}
# Gam modeL
BMI.gam = gam((BMI) ~ (Height) * (Age),data = BMI.data,span=0.45)

# Create augmented dataframe for gam
BMI.gam.df = augment(BMI.gam)

#R squared for the gam
gam.R2 = var(BMI.gam.df$.fitted) / (var(BMI.gam.df$.fitted)+var(BMI.gam.df$.resid))

print(BMI.gam)
cat("R squared= ",gam.R2)
### Modeling the data

```




#####Graph faceted by age that shows how, according to your model, average BMI varies with height.
```{r,message=F,warning=F,echo=F}
newdata1 = expand.grid( Age = seq(2,17,1),Height = seq(80,210,20))
BMI.pred1 = predict(BMI.lo, newdata = newdata1)
BMI.pred1 = data.frame(newdata1, predicted_BMI = as.vector(BMI.pred1))

ggplot(BMI.pred1, aes(x = (Height), y = predicted_BMI, group = Age, color = factor(Age))) +geom_point()+geom_line()+ facet_wrap(~Age,ncol = 4) + scale_color_manual(values = cb_palette) + labs(color = "Age")+theme(axis.text=element_text(size=7),
        axis.title=element_text(size=7,face="bold"))

```

#####Graph  which  uses color  to  denote  age  that  shows  how,  according  to  your  model,average  BMI  varies  with height.
```{r,message=F,warning=F,echo=F}
newdata1 = expand.grid(Height = seq(80,210,20), Age = seq(2,17,1))
BMI.pred1 = predict(BMI.lo, newdata = newdata1)
BMI.pred1 = data.frame(newdata1, predicted_BMI = as.vector(BMI.pred1))

ggplot(BMI.pred1, aes(x = (Height), y = predicted_BMI, group = Age, color = factor(Age))) +geom_point()+geom_line()+ scale_color_manual(values = cb_palette) + labs(color = "Age")+theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"))

```

### Visualizing the fit: geom_raster and geom_contour
```{r,warning=F,message=F,echo=F}

BMI.plot.grid = expand.grid(Height=seq(120,210,20), Age=seq(2,17,1))
BMI.plot.predict = predict(BMI.lo, newdata=BMI.plot.grid)
BMI.plot.df = data.frame(BMI.plot.grid, fit=as.vector(BMI.plot.predict))
```


```{r,warning=F,message=F,echo=F}
ggplot(BMI.plot.df, aes(x=Height, y=Age, z=fit)) + geom_raster(aes(fill=fit)) + coord_fixed() + scale_fill_distiller(palette="RdYlBu")+geom_contour()
```

#####Question 1
How does average BMI vary with height and age for children 17 and under?


1. The distribution for average BMI value follows same pattern for the given dataset, there is increase in BMI value    as age and height increases which can be easily visualize From the contour plot the right top corner in red color    indicates the region with high BMI value and light sky color in the left bottom corner shows the lowest BMI value    region.

2. As we increase the age of the children corresponding to a height, there is increase in average BMI value as it is    usual that the person with same height but different age to have different weight and according to the given         data age has positive correlation with the average weight for same height.

3. As we increase the height of the children keeping the age same there is increase in average BMI value as increase    in height results in increase in body weight.


#####Question 2
Is BMI a good measure of body mass for children?

In my opinion, BMI is certainly not a good measure of body mass for children because other factors such as age,sex, ethnicity, sexual maturation and muscle mass can influence the relationship between BMI and body mass for children. BMI does not distinguish between excess fat, bone mass, muscle. Hence, BMI has limitations while assessing weight.

For example, On average, the male children have high muscle mass than the female children of same height.

Moreover, BMI may exaggerate high mass in short heighted children and thinness in long heighted children.


